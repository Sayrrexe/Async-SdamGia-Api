name: Verify Installed Package from TestPyPI

on:
  workflow_run:
    workflows: ["Publish to TestPyPI"]
    types: [completed]

jobs:
  verify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source revision used for publish
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Resolve package version from pyproject.toml
        run: |
          python - <<'PY'
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          name = data["project"]["name"]
          version = data["project"]["version"]
          Path("/tmp/package_version.env").write_text(
              f"PACKAGE_NAME={name}\nPACKAGE_VERSION={version}\n",
              encoding="utf-8",
          )
          PY
          cat /tmp/package_version.env >> "$GITHUB_ENV"

      - name: Install package from TestPyPI (with retry)
        run: |
          python -m pip install --upgrade pip
          for attempt in 1 2 3 4 5 6 7 8 9 10; do
            if pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ "${PACKAGE_NAME}==${PACKAGE_VERSION}"; then
              echo "Installed ${PACKAGE_NAME}==${PACKAGE_VERSION} from TestPyPI"
              break
            fi
            if [ "$attempt" -eq 10 ]; then
              echo "Package is not available on TestPyPI after retries"
              exit 1
            fi
            sleep 15
          done

      - name: Run smoke checks against installed package
        run: |
          cd /tmp
          python - <<'PY'
          import asyncio
          from sdamgia import SdamGIA

          async def run_smoke_checks() -> None:
            async with SdamGIA() as api:
              assert isinstance(api, SdamGIA)
              result = await api.search("math", "Найдите количество")

            assert isinstance(result, list)
            assert result
            assert all(
                isinstance(problem_id, str) and problem_id.isdigit()
                for problem_id in result
            )
            print("Installed package smoke check passed")

          asyncio.run(run_smoke_checks())
          PY
